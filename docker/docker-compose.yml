version: '3.8'

# ============================================================================
# KaFlow-Py Docker Compose é…ç½®
# ç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
# ============================================================================

services:
  # KaFlow-Py åç«¯æœåŠ¡
  kaflow-py:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: kaflow-py:latest
    container_name: kaflow-py
    
    # ğŸ¯ ä» .env æ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡
    env_file:
      - ../.env  # è¯»å–é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶
    
    # å¢åŠ å…±äº«å†…å­˜ï¼Œæµè§ˆå™¨éœ€è¦
    shm_size: '2gb'
    
    # ğŸ¯ è§£å†³ "can't start new thread" é—®é¢˜ï¼šå¢åŠ è¿›ç¨‹/çº¿ç¨‹æ•°é™åˆ¶
    ulimits:
      nproc: 1000  # æœ€å¤§è¿›ç¨‹æ•°
      nofile:       # æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°
        soft: 1000
        hard: 1000
    
    # èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼Œé˜²æ­¢èµ„æºæ³„éœ²ï¼‰
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    
    ports:
      - "8101:8101"
    
    environment:
      # æœåŠ¡é…ç½®
      - KAFLOW_HOST=0.0.0.0
      - KAFLOW_PORT=8101
      - KAFLOW_RELOAD=false
      - KAFLOW_LOG_LEVEL=info
      
      # ğŸ’¡ API Keys å·²é€šè¿‡ env_file è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€åœ¨è¿™é‡Œé‡å¤é…ç½®
      # å¦‚æœéœ€è¦è¦†ç›– .env æ–‡ä»¶ä¸­çš„å€¼ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®
      
    
    volumes:
      # æŒ‚è½½é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆå¯é€‰ï¼Œç”¨äºçƒ­æ›´æ–°é…ç½®ï¼‰
      - ../src/core/config:/app/src/core/config
      
      # æŒ‚è½½æ—¥å¿—ç›®å½•
      - ./logs:/app/logs
      
      # æŒ‚è½½æ•°æ®ç›®å½•ï¼ˆå¦‚éœ€æŒä¹…åŒ–ï¼‰
      - ./data:/app/data
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - kaflow-network

networks:
  kaflow-network:
    driver: bridge
    name: kaflow-network

