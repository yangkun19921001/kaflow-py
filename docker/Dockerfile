# ============================================================================
# KaFlow-Py Dockerfile
# åŸºäºé…ç½®é©±åŠ¨çš„ AI Agent å¼€å‘æ¡†æ¶
# ============================================================================

FROM ghcr.io/astral-sh/uv:python3.13-bookworm

# Install uv (already included in base image)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# è®¾ç½®ç»´æŠ¤è€…ä¿¡æ¯
LABEL maintainer="DevYK <yang1001yk@gmail.com>"
LABEL description="KaFlow-Py - Configuration-driven AI Agent Development Framework"
LABEL version="1.0.0"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    KAFLOW_HOST=0.0.0.0 \
    KAFLOW_PORT=8101 \
    KAFLOW_RELOAD=false \
    KAFLOW_LOG_LEVEL=info \
    PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0 \
    UV_PYTHON=3.13

# ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆæé«˜ä¸‹è½½é€Ÿåº¦å’Œç¨³å®šæ€§ï¼‰
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list || true

# å®‰è£…ç³»ç»Ÿä¾èµ–å’Œ Playwright æµè§ˆå™¨ä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends --fix-missing \
    wget \
    vim \
    curl \
    && rm -rf /var/lib/apt/lists/*

# é…ç½® PyPI å›½å†…é•œåƒæºï¼ˆæé«˜ä¸‹è½½é€Ÿåº¦ï¼‰
RUN mkdir -p /root/.config/pip && \
    echo "[global]" > /root/.config/pip/pip.conf && \
    echo "index-url = https://mirrors.aliyun.com/pypi/simple/" >> /root/.config/pip/pip.conf && \
    echo "trusted-host = mirrors.aliyun.com" >> /root/.config/pip/pip.conf && \
    echo "timeout = 120" >> /root/.config/pip/pip.conf

# ğŸ¯ ä¼˜åŒ–æ„å»ºç¼“å­˜ï¼šå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶
# åªæœ‰å½“ pyproject.toml æˆ– uv.lock æ”¹å˜æ—¶æ‰é‡æ–°å®‰è£…ä¾èµ–
COPY pyproject.toml uv.lock ./
COPY src ./src
COPY server.py ./
COPY .env ./

RUN --mount=type=cache,target=/root/.cache/uv \
    UV_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/ \
    UV_EXTRA_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple \
    UV_HTTP_TIMEOUT=300 \
    uv sync




# å®‰è£… Playwright æµè§ˆå™¨ï¼ˆChromiumï¼‰
# åˆ›å»ºæµè§ˆå™¨ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /ms-playwright && \
    chmod -R 755 /ms-playwright

# å…ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼Œå†å®‰è£…æµè§ˆå™¨
RUN uv run playwright install-deps chromium

# å®‰è£… Chromium æµè§ˆå™¨
RUN uv run playwright install chromium

# éªŒè¯æµè§ˆå™¨å®‰è£…
RUN uv run python -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); print('Browser installed:', p.chromium.executable_path); p.stop()"

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs

# æš´éœ²ç«¯å£
EXPOSE 8101

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8101/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["uv", "run", "python", "server.py", "--host", "0.0.0.0", "--port", "8101"] 