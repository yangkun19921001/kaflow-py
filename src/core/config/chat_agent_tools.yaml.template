# =================================================================
# KaFlow-Py 聊天机器人模版 (带工具版本)
# 基于 KaFlow-Py 协议标准的智能聊天 Agent 配置，集成多种实用工具
# =================================================================

# =================================================================
# 协议版本与元信息
# =================================================================
protocol:
  name: "KaFlow-Py Chat Agent with Tools Template"
  version: "1.0.0"
  schema_version: "2025.09.10"
  description: "基于 KaFlow-Py 协议标准的智能聊天机器人模版，集成文件操作、系统信息、计算器等工具"
  author: "DevYK"
  license: "MIT"

# =================================================================
# 全局配置
# =================================================================
global_config:
  # 运行时配置
  runtime:
    timeout: 180
    max_retries: 3
    parallel_limit: 2
    debug_mode: false
    trace_enabled: true
    checkpoint_enabled: true

  # 日志配置
  logging:
    level: "INFO"
    format: "json"
    output: "stdout"
    file_path: "./logs/chat_agent_tools.log"
    max_size: "50MB"
    max_files: 5

# =================================================================
# Agent 配置 (符合 agent_schema.base_structure)
# =================================================================
agents:
  chat_agent_with_tools:
    name: "chat_agent_with_tools"                  # Agent 名称
    type: "react_agent"                                  # Agent 类型，使用 ReAct 支持工具
    description: "智能聊天机器人，支持文件操作、系统查询、数学计算等功能"
    enabled: true                                  # 是否启用
    
    system_prompt: |                               # 系统提示词
      你是一个强大的AI助手，具备多种实用工具。你的任务是：
      
      1. 理解用户的问题和需求
      2. 合理使用可用的工具来帮助用户解决问题
      3. 提供准确、有用的回答和操作结果
      4. 保持对话的连贯性和上下文理解
      5. 用温和、专业的语气与用户交流
      
      可用工具说明：
      - file_reader: 读取文件内容
      - file_writer: 写入文件内容  
      - system_info: 获取系统信息
      - calculator: 进行数学计算
      - current_time: 获取当前时间
      
      使用工具时请：
      - 根据用户需求选择合适的工具
      - 清楚解释你要执行的操作
      - 总结工具执行的结果
      - 如果操作失败，提供替代方案
      
      请始终记住之前的对话内容，并根据上下文提供相关回答。
    
    llm:                                           # Agent 专用 LLM 配置
      provider: "deepseek"
      base_url: "https://api.ppinfra.com/v3/openai"
      api_key: "${DEEPSEEK_API_KEY}"
      model: "deepseek/deepseek-v3-0324"
      temperature: 0.3
      max_tokens: 4096
      timeout: 60
      
    tools:                                         # 可用工具列表
      - name: "file_reader"
        description: "读取指定文件的内容"
        parameters:
          type: "object"
          properties:
            file_path:
              type: "string"
              description: "要读取的文件路径"
          required: ["file_path"]
            
      - name: "file_writer"
        description: "将内容写入指定文件"
        parameters:
          type: "object"
          properties:
            file_path:
              type: "string"
              description: "要写入的文件路径"
            content:
              type: "string"
              description: "要写入的内容"
            mode:
              type: "string"
              description: "写入模式：write(覆盖) 或 append(追加)"
              enum: ["write", "append"]
              default: "write"
          required: ["file_path", "content"]
          
      - name: "system_info"
        description: "获取系统信息"
        parameters:
          type: "object"
          properties:
            info_type:
              type: "string"
              description: "信息类型：platform, cpu, memory, disk, network"
              enum: ["platform", "cpu", "memory", "disk", "network", "all"]
              default: "all"
          required: []
          
      - name: "calculator"
        description: "执行数学计算"
        parameters:
          type: "object"
          properties:
            expression:
              type: "string"
              description: "数学表达式，支持基本运算、函数等"
          required: ["expression"]
          
      - name: "current_time"
        description: "获取当前时间信息"
        parameters:
          type: "object"
          properties:
            format:
              type: "string"
              description: "时间格式：datetime, timestamp, iso"
              enum: ["datetime", "timestamp", "iso"]
              default: "datetime"
            timezone:
              type: "string"
              description: "时区，如 UTC, Asia/Shanghai"
              default: "local"
          required: []
    
    mcp_servers: []                                # MCP 服务器列表 (暂不使用)

# =================================================================
# 工作流配置 (符合 workflow_schema.base_config)
# =================================================================
workflow:
  name: "智能工具聊天机器人工作流"
  version: "1.0.0"
  description: "集成多种实用工具的聊天机器人，支持文件操作、系统查询、数学计算等"
  author: "DevYK"
  schema_version: "2025.09.10"
  
  settings:
    timeout: 180
    max_retries: 3
    debug_mode: false

  # =================================================================
  # 节点定义 (符合 node_schema.base_structure)
  # =================================================================
  nodes:
    - name: "start_node"
      type: "start"
      description: "工作流开始节点"
      position:
        x: 100
        y: 100
      outputs:
        - name: "user_input"
          type: "string"
          description: "用户输入内容"

    - name: "chat_agent_with_tools"
      type: "agent"
      description: "智能聊天机器人 Agent (带工具)"
      agent_ref: "chat_agent_with_tools"  # 引用 agents 配置段中的 chat_agent_with_tools
      position:
        x: 300
        y: 100
      
      inputs:
        - name: "user_message"
          type: "string"
          required: true
          source: "start_node.user_input"
          description: "用户输入的消息"
        - name: "thread_id"
          type: "string"
          required: false
          description: "对话线程ID，用于记忆管理"
      
      outputs:
        - name: "response"
          type: "string"
          description: "AI助手的回复"
        - name: "tool_results"
          type: "array"
          description: "工具执行结果列表"
        - name: "confidence"
          type: "number"
          description: "回答的置信度"

    - name: "end_node"
      type: "end"
      description: "工作流结束节点"
      position:
        x: 500
        y: 100
      inputs:
        - name: "final_response"
          type: "string"
          required: true
          source: "chat_agent_with_tools.response"
          description: "最终回复内容"
        - name: "tool_results"
          type: "array"
          required: false
          source: "chat_agent_with_tools.tool_results"
          description: "工具执行结果"

  # =================================================================
  # 边定义 (符合 edge_schema.base_structure)
  # =================================================================
  edges:
    - from: "start_node"
      to: "chat_agent_with_tools"
      description: "传递用户输入到智能聊天Agent"
      
    - from: "chat_agent_with_tools"
      to: "end_node"
      description: "输出最终回复和工具执行结果"

# =================================================================
# 使用说明
# =================================================================
usage_notes: |
  智能工具聊天机器人模版使用说明：
  
  1. 功能特点：
     - 完全符合 KaFlow-Py 协议标准
     - 集成 5 种实用工具：文件操作、系统信息、计算器、时间查询
     - 支持连续对话和上下文理解
     - 自动记忆管理（基于全局memory配置）
     - ReAct Agent 架构，支持推理-行动-观察循环
     - 智能工具选择和结果解释
  
  2. 支持的工具：
     - 📁 file_reader: 读取文件内容
     - ✏️ file_writer: 写入文件内容
     - 💻 system_info: 获取系统信息
     - 🧮 calculator: 数学计算
     - ⏰ current_time: 时间查询
  
  3. 使用示例：
     - "帮我读取 /tmp/test.txt 文件的内容"
     - "计算 (25 + 75) * 0.8 的结果"
     - "获取当前系统的内存使用情况"
     - "将这段文字保存到 notes.txt 文件中"
     - "现在几点了？"
  
  4. 环境变量：
     - DEEPSEEK_API_KEY: DeepSeek API密钥
     - 或者 OPENAI_API_KEY: OpenAI API密钥
  
  5. 启动方式：
     python main.py --config config/chat_agent_tools.yaml
  
  6. 自定义配置：
     - 修改 system_prompt 定制AI助手的行为和工具使用策略
     - 调整 temperature 控制回答的创造性（工具版建议较低值）
     - 修改 max_tokens 控制回答长度
     - 添加或修改 tools 配置扩展功能
     - 配置 mcp_servers 集成外部工具服务 