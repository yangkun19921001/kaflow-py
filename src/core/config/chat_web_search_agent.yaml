# =================================================================
# KaFlow-Py èŠå¤©æœºå™¨äººæ¨¡ç‰ˆ (MCP é›†æˆç‰ˆæœ¬)
# åŸºäº KaFlow-Py åè®®æ ‡å‡†çš„æ™ºèƒ½èŠå¤©æœºå™¨äººæ¨¡ç‰ˆï¼Œé›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡
# =================================================================

id: 3

# =================================================================
# åè®®ç‰ˆæœ¬ä¸å…ƒä¿¡æ¯
# =================================================================
protocol:
  name: "æ™ºèƒ½æœç´¢åŠ©æ‰‹"
  version: "1.0.0"
  schema_version: "2025.09.10"
  description: "æ™ºèƒ½æœç´¢åŠ©æ‰‹ï¼Œå¯ä»¥è¿›è¡Œç½‘ç»œæœç´¢ï¼Œå¹¶è¿”å›æœç´¢ç»“æœ"
  author: "DevYK"
  license: "MIT"

# =================================================================
# å…¨å±€é…ç½®
# =================================================================
global_config:
  # è¿è¡Œæ—¶é…ç½®
  runtime:
    timeout: 180
    max_retries: 3
    parallel_limit: 2
    debug_mode: false
    trace_enabled: true
    checkpoint_enabled: true

  # æ—¥å¿—é…ç½®
  logging:
    level: "INFO"
    format: "json"
    output: "stdout"
    file_path: "./logs/chat_agent_mcp.log"
    max_size: "50MB"
    max_files: 5

  # å†…å­˜é…ç½®
  # è®°å¿†å­˜å‚¨é…ç½®
  memory:                                    # è®°å¿†å­˜å‚¨é…ç½® (å¯é€‰)
    enabled: false                            # å¯ç”¨è®°å¿†å­˜å‚¨ (å¯é€‰)
    provider: "memory"                       # å­˜å‚¨æä¾›å•†: memory|redis|postgresql|mongodb|sqlite (å¯é€‰)


# =================================================================
# Agent é…ç½® (ç¬¦åˆ agent_schema.base_structure)
# =================================================================
agents:
  web_search_agent:
    name: "web_search_agent"                  # Agent åç§°
    type: "react_agent"                          # Agent ç±»å‹ï¼Œä½¿ç”¨ ReAct æ”¯æŒå·¥å…·
    description: "æ™ºèƒ½æœç´¢åŠ©æ‰‹ï¼Œå¯ä»¥è¿›è¡Œç½‘ç»œæœç´¢ï¼Œå¹¶è¿”å›æœç´¢ç»“æœ"
    enabled: true                                # æ˜¯å¦å¯ç”¨
    
    system_prompt: |                             # ç³»ç»Ÿæç¤ºè¯
      ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ™ºèƒ½æœç´¢åŠ©æ‰‹ ğŸ”ï¼Œå…·å¤‡å¼ºå¤§çš„ç½‘ç»œæœç´¢å’Œä¿¡æ¯æ•´ç†èƒ½åŠ›ï¼
      
      **æ ¸å¿ƒèƒ½åŠ›**ï¼š
      1. ğŸŒ ä½¿ç”¨ web_search å·¥å…·è¿›è¡Œç²¾å‡†çš„ç½‘ç»œæœç´¢
      2. ğŸ“Š æ™ºèƒ½è§£æå’Œç­›é€‰æœç´¢ç»“æœ
      3. ğŸ’¡ æä¾›ç»“æ„åŒ–ã€æ˜“ç†è§£çš„ä¿¡æ¯æ€»ç»“
      4. ğŸ¯ æ ¹æ®ç”¨æˆ·éœ€æ±‚æä¾›é’ˆå¯¹æ€§çš„æœç´¢ç­–ç•¥
      
      **æœç´¢ç­–ç•¥**ï¼š
      - ç†è§£ç”¨æˆ·çš„çœŸå®éœ€æ±‚ï¼Œä¼˜åŒ–æœç´¢å…³é”®è¯
      - ä»å¤šä¸ªè§’åº¦æœç´¢ï¼Œç¡®ä¿ä¿¡æ¯çš„å…¨é¢æ€§
      - ä¼˜å…ˆæä¾›æœ€æ–°ã€æœ€æƒå¨çš„ä¿¡æ¯æº
      - å¯¹æœç´¢ç»“æœè¿›è¡Œå»é‡å’Œè´¨é‡ç­›é€‰
      
      **ä¿¡æ¯å‘ˆç°**ï¼š
      - ğŸ“‹ ç»“æ„åŒ–å±•ç¤ºæœç´¢ç»“æœï¼ˆæ ‡é¢˜ã€æ‘˜è¦ã€æ¥æºï¼‰
      - ğŸ”— æä¾›åŸå§‹é“¾æ¥ä¾›ç”¨æˆ·æ·±å…¥äº†è§£
      - ğŸ“ˆ çªå‡ºå…³é”®ä¿¡æ¯å’Œæ•°æ®
      - ğŸ·ï¸ æ ‡æ³¨ä¿¡æ¯çš„æ—¶æ•ˆæ€§å’Œå¯é æ€§
      
      **äº¤äº’é£æ ¼**ï¼š
      - å‹å¥½ä¸“ä¸šï¼Œåƒèµ„æ·±ç ”ç©¶å‘˜ä¸€æ ·æä¾›å¸®åŠ©
      - ä¸»åŠ¨è¯¢é—®ç»†èŠ‚ï¼Œç¡®ä¿æœç´¢æ–¹å‘å‡†ç¡®
      - å¦‚æœæœç´¢ç»“æœä¸ç†æƒ³ï¼Œä¸»åŠ¨å»ºè®®ä¼˜åŒ–æœç´¢ç­–ç•¥
      - æä¾›ç›¸å…³çš„å»¶ä¼¸æœç´¢å»ºè®®
      
      **å·¥å…·ä½¿ç”¨è¯´æ˜**ï¼š
      - web_search: æ‰§è¡Œç½‘ç»œæœç´¢
        å‚æ•°ï¼š
        query: æœç´¢æŸ¥è¯¢å…³é”®è¯
        max_results: è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡ï¼Œé»˜è®¤ä¸º 10
        ç¤ºä¾‹ï¼šweb_search(query="2024å¹´äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿", max_results=10, search_type="general")

      **æ³¨æ„äº‹é¡¹**ï¼š
      - å§‹ç»ˆéªŒè¯ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§
      - å¯¹äºæ•æ„Ÿè¯é¢˜ï¼Œæä¾›å¤šæ–¹è§‚ç‚¹
      - å¦‚æœæœç´¢æ— ç»“æœï¼Œå»ºè®®è°ƒæ•´æœç´¢ç­–ç•¥
      - ä¿æŒå®¢è§‚ä¸­ç«‹ï¼Œé¿å…åè§
      
      è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢çŸ¥è¯†çš„æµ·æ´‹ï¼Œä¸ºä½ æ‰¾åˆ°æœ€æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼âœ¨
    
    llm:                                         # Agent ä¸“ç”¨ LLM é…ç½®
      provider: "deepseek"
      base_url: "https://api.ppinfra.com/v3/openai"
      api_key: "${DEEPSEEK_API_KEY}"
      model: "deepseek/deepseek-v3-0324"
      temperature: 0.3
      max_tokens: 4096
      timeout: 60
      
    tools: 
      - name: "web_search"  # ç½‘ç»œæœç´¢å·¥å…·
        type: "web_search"  # ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºä½¿ç”¨ web_search tool
        description: "ä½¿ç”¨ç½‘ç»œæœç´¢å·¥å…·è¿›è¡Œç½‘ç»œæœç´¢"
        config:
          max_results: 5  # è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡
          search_type: "general"  # æœç´¢ç±»å‹ï¼Œå¯é€‰å€¼ä¸º "general" æˆ– "news"
    
    mcp_servers: []                                 # MCP æœåŠ¡å™¨é…ç½®

# =================================================================
# å·¥ä½œæµé…ç½® (ç¬¦åˆ workflow_schema.base_config)
# =================================================================
workflow:
  name: "æ™ºèƒ½ MCP èŠå¤©æœºå™¨äººå·¥ä½œæµ"
  version: "1.0.0"
  description: "é›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡çš„èŠå¤©æœºå™¨äººï¼Œæ”¯æŒè¿œç¨‹å‘½ä»¤æ‰§è¡Œç­‰åŠŸèƒ½"
  author: "DevYK"
  schema_version: "2025.09.10"
  
  settings:
    timeout: 180
    max_retries: 3
    debug_mode: false

  # =================================================================
  # èŠ‚ç‚¹å®šä¹‰ (ç¬¦åˆ node_schema.base_structure)
  # =================================================================
  nodes:
    - name: "start_node"
      type: "start"
      description: "å·¥ä½œæµå¼€å§‹èŠ‚ç‚¹"
      position:
        x: 100
        y: 100
      outputs:
        - name: "user_input"
          type: "string"
          description: "ç”¨æˆ·è¾“å…¥å†…å®¹"

    - name: "web_search_agent"
      type: "agent"
      description: "æ™ºèƒ½èŠå¤©æœºå™¨äºº Agent (é›†æˆ MCP)"
      agent_ref: "web_search_agent"  # å¼•ç”¨ agents é…ç½®æ®µä¸­çš„ web_search_agent
      position:
        x: 300
        y: 100
      
      inputs:
        - name: "user_message"
          type: "string"
          required: true
          source: "start_node.user_input"
          description: "ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯"
        - name: "thread_id"
          type: "string"
          required: false
          description: "å¯¹è¯çº¿ç¨‹IDï¼Œç”¨äºè®°å¿†ç®¡ç†"
      
      outputs:
        - name: "response"
          type: "string"
          description: "AIåŠ©æ‰‹çš„å›å¤"
        - name: "mcp_results"
          type: "array"
          description: "MCP å·¥å…·æ‰§è¡Œç»“æœåˆ—è¡¨"
        - name: "confidence"
          type: "number"
          description: "å›ç­”çš„ç½®ä¿¡åº¦"

    - name: "end_node"
      type: "end"
      description: "å·¥ä½œæµç»“æŸèŠ‚ç‚¹"
      position:
        x: 500
        y: 100
      inputs:
        - name: "final_response"
          type: "string"
          required: true
          source: "web_search_agent.response"
          description: "æœ€ç»ˆå›å¤å†…å®¹"
        - name: "mcp_results"
          type: "array"
          required: false
          source: "web_search_agent.mcp_results"
          description: "MCP å·¥å…·æ‰§è¡Œç»“æœ"

  # =================================================================
  # è¾¹å®šä¹‰ (ç¬¦åˆ edge_schema.base_structure)
  # =================================================================
  edges:
    - from: "start_node"
      to: "web_search_agent"
      description: "ä¼ é€’ç”¨æˆ·è¾“å…¥åˆ°æ™ºèƒ½èŠå¤©Agent"
      
    - from: "web_search_agent"
      to: "end_node"
      description: "è¾“å‡ºæœ€ç»ˆå›å¤å’Œ MCP æ‰§è¡Œç»“æœ"

# =================================================================
# ä½¿ç”¨è¯´æ˜
# =================================================================
usage_notes: |
  æ™ºèƒ½ MCP èŠå¤©æœºå™¨äººæ¨¡ç‰ˆä½¿ç”¨è¯´æ˜ï¼š
  
  1. åŠŸèƒ½ç‰¹ç‚¹ï¼š
     - å®Œå…¨ç¬¦åˆ KaFlow-Py åè®®æ ‡å‡†
     - é›†æˆ MCP (Model Context Protocol) å¤–éƒ¨å·¥å…·æœåŠ¡
     - æ”¯æŒè¿œç¨‹å‘½ä»¤æ‰§è¡Œå’Œå…¶ä»– MCP å·¥å…·
     - æ”¯æŒè¿ç»­å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£
     - è‡ªåŠ¨è®°å¿†ç®¡ç†ï¼ˆåŸºäºå…¨å±€memoryé…ç½®ï¼‰
     - ReAct Agent æ¶æ„ï¼Œæ”¯æŒæ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯
     - æ™ºèƒ½å·¥å…·é€‰æ‹©å’Œç»“æœè§£é‡Š
  
  2. MCP é›†æˆç‰¹æ€§ï¼š
     - ğŸŒ remote_exec: è¿œç¨‹å‘½ä»¤æ‰§è¡Œå·¥å…·
     - ğŸ”§ è‡ªåŠ¨å·¥å…·å‘ç°å’ŒåŠ è½½
     - ğŸ”„ å·¥å…·è°ƒç”¨é‡è¯•æœºåˆ¶
     - âš¡ SSE (Server-Sent Events) ä¼ è¾“åè®®
     - ğŸ›¡ï¸ å®‰å…¨çš„å·¥å…·è°ƒç”¨éªŒè¯
  
  3. ä½¿ç”¨ç¤ºä¾‹ï¼š
     - "åœ¨æœºå™¨ 420c126d598a97ee31fb70127b6b9a46 ä¸Šæ‰§è¡Œ ls -la å‘½ä»¤"
     - "æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ"
     - "è·å–è¿œç¨‹æœºå™¨çš„ç³»ç»Ÿä¿¡æ¯"
     - "æ‰§è¡Œè¿œç¨‹è„šæœ¬æˆ–å‘½ä»¤"
  
  4. ç¯å¢ƒå˜é‡ï¼š
     - DEEPSEEK_API_KEY: DeepSeek APIå¯†é’¥
     - æˆ–è€… OPENAI_API_KEY: OpenAI APIå¯†é’¥
  
  5. MCP æœåŠ¡å™¨è¦æ±‚ï¼š
     - æœåŠ¡å™¨åœ°å€: http://10.1.16.4:8000/mcp/sse
     - ä¼ è¾“åè®®: SSE (Server-Sent Events)
     - å¿…é¡»å®ç° MCP åè®®è§„èŒƒ
     - æä¾› remote_exec å·¥å…·
  
  6. å¯åŠ¨æ–¹å¼ï¼š
     python main.py --config config/chat_agent_mcp.yaml
  
  7. è‡ªå®šä¹‰é…ç½®ï¼š
     - ä¿®æ”¹ system_prompt å®šåˆ¶AIåŠ©æ‰‹çš„è¡Œä¸ºå’Œ MCP å·¥å…·ä½¿ç”¨ç­–ç•¥
     - è°ƒæ•´ temperature æ§åˆ¶å›ç­”çš„åˆ›é€ æ€§ï¼ˆMCPç‰ˆå»ºè®®è¾ƒä½å€¼ï¼‰
     - ä¿®æ”¹ max_tokens æ§åˆ¶å›ç­”é•¿åº¦
     - é…ç½® mcp_servers æ·»åŠ æ›´å¤šå¤–éƒ¨å·¥å…·æœåŠ¡
     - è®¾ç½®å·¥å…·è°ƒç”¨çš„è¶…æ—¶å’Œé‡è¯•å‚æ•°
  
  8. å®‰å…¨æ³¨æ„äº‹é¡¹ï¼š
     - MCP å·¥å…·å…·æœ‰å¼ºå¤§çš„è¿œç¨‹æ‰§è¡Œèƒ½åŠ›ï¼Œè¯·è°¨æ…ä½¿ç”¨
     - å»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­æµ‹è¯•
     - é¿å…æ‰§è¡Œå¯èƒ½é€ æˆæŸå®³çš„å‘½ä»¤
     - å®šæœŸæ£€æŸ¥å’Œå®¡è®¡å·¥å…·è°ƒç”¨æ—¥å¿— 