# =================================================================
# KaFlow-Py èŠå¤©æœºå™¨äººæ¨¡ç‰ˆ (MCP é›†æˆç‰ˆæœ¬)
# åŸºäº KaFlow-Py åè®®æ ‡å‡†çš„æ™ºèƒ½èŠå¤©æœºå™¨äººæ¨¡ç‰ˆï¼Œé›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡
# =================================================================

# =================================================================
# åè®®ç‰ˆæœ¬ä¸å…ƒä¿¡æ¯
# =================================================================
protocol:
  name: "KaFlow-Py Chat Agent with MCP Template"
  version: "1.0.0"
  schema_version: "2025.09.10"
  description: "åŸºäº KaFlow-Py åè®®æ ‡å‡†çš„æ™ºèƒ½èŠå¤©æœºå™¨äººæ¨¡ç‰ˆï¼Œé›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡"
  author: "DevYK"
  license: "MIT"

# =================================================================
# å…¨å±€é…ç½®
# =================================================================
global_config:
  # è¿è¡Œæ—¶é…ç½®
  runtime:
    timeout: 180
    max_retries: 3
    parallel_limit: 2
    debug_mode: false
    trace_enabled: true
    checkpoint_enabled: true

  # æ—¥å¿—é…ç½®
  logging:
    level: "INFO"
    format: "json"
    output: "stdout"
    file_path: "./logs/chat_agent_mcp.log"
    max_size: "50MB"
    max_files: 5

# =================================================================
# Agent é…ç½® (ç¬¦åˆ agent_schema.base_structure)
# =================================================================
agents:
  chat_agent_with_mcp:
    name: "chat_agent_with_mcp"                  # Agent åç§°
    type: "react_agent"                          # Agent ç±»å‹ï¼Œä½¿ç”¨ ReAct æ”¯æŒå·¥å…·
    description: "æ™ºèƒ½èŠå¤©æœºå™¨äººï¼Œé›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡ï¼Œæ”¯æŒè¿œç¨‹å‘½ä»¤æ‰§è¡Œç­‰åŠŸèƒ½"
    enabled: true                                # æ˜¯å¦å¯ç”¨
    
    system_prompt: |                             # ç³»ç»Ÿæç¤ºè¯
      ä½ æ˜¯ä¸€ä¸ªå¼ºå¤§çš„AIåŠ©æ‰‹ï¼Œå…·å¤‡é€šè¿‡ MCP (Model Context Protocol) è°ƒç”¨å¤–éƒ¨å·¥å…·çš„èƒ½åŠ›ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
      
      1. ç†è§£ç”¨æˆ·çš„é—®é¢˜å’Œéœ€æ±‚
      2. åˆç†ä½¿ç”¨å¯ç”¨çš„ MCP å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜
      3. æä¾›å‡†ç¡®ã€æœ‰ç”¨çš„å›ç­”å’Œæ“ä½œç»“æœ
      4. ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œä¸Šä¸‹æ–‡ç†è§£
      5. ç”¨æ¸©å’Œã€ä¸“ä¸šçš„è¯­æ°”ä¸ç”¨æˆ·äº¤æµ
      
      å¯ç”¨çš„ MCP å·¥å…·åŠŸèƒ½ï¼š
      - remote_exec: è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œå¯ä»¥åœ¨æŒ‡å®šæœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤
      - å…¶ä»–é€šè¿‡ MCP æœåŠ¡å™¨æä¾›çš„å·¥å…·
      
      ä½¿ç”¨ MCP å·¥å…·æ—¶è¯·ï¼š
      - æ ¹æ®ç”¨æˆ·éœ€æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·
      - æ¸…æ¥šè§£é‡Šä½ è¦æ‰§è¡Œçš„æ“ä½œ
      - æ€»ç»“å·¥å…·æ‰§è¡Œçš„ç»“æœ
      - å¦‚æœæ“ä½œå¤±è´¥ï¼Œæä¾›æ›¿ä»£æ–¹æ¡ˆæˆ–é”™è¯¯è¯´æ˜
      - æ³¨æ„å®‰å…¨æ€§ï¼Œé¿å…æ‰§è¡Œå±é™©å‘½ä»¤
      
      è¯·å§‹ç»ˆè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œå¹¶æ ¹æ®ä¸Šä¸‹æ–‡æä¾›ç›¸å…³å›ç­”ã€‚
    
    llm:                                         # Agent ä¸“ç”¨ LLM é…ç½®
      provider: "deepseek"
      base_url: "https://api.ppinfra.com/v3/openai"
      api_key: "${DEEPSEEK_API_KEY}"
      model: "deepseek/deepseek-v3-0324"
      temperature: 0.3
      max_tokens: 4096
      timeout: 60
      
    tools: []                                    # å†…ç½®å·¥å…·åˆ—è¡¨ (ç©ºè¡¨ç¤ºåªä½¿ç”¨ MCP å·¥å…·)
    
    mcp_servers:                                 # MCP æœåŠ¡å™¨é…ç½®
      - name: "remote_execution_server"
        description: "è¿œç¨‹å‘½ä»¤æ‰§è¡Œ MCP æœåŠ¡å™¨"
        transport: "sse"
        url: "http://10.1.16.4:8000/mcp/sse"
        timeout_seconds: 30
        enabled: true
        retry_attempts: 3
        
        # é¢„æœŸçš„å·¥å…·åˆ—è¡¨ (ç”¨äºéªŒè¯)
        expected_tools:
          - name: "remote_exec"
            description: "åœ¨è¿œç¨‹æœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤"
            parameters:
              type: "object"
              properties:
                machineId:
                  type: "string"
                  description: "ç›®æ ‡æœºå™¨ID"
                script:
                  type: "string"
                  description: "è¦æ‰§è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬"
              required: ["machineId", "script"]

# =================================================================
# å·¥ä½œæµé…ç½® (ç¬¦åˆ workflow_schema.base_config)
# =================================================================
workflow:
  name: "æ™ºèƒ½ MCP èŠå¤©æœºå™¨äººå·¥ä½œæµ"
  version: "1.0.0"
  description: "é›†æˆ MCP å¤–éƒ¨å·¥å…·æœåŠ¡çš„èŠå¤©æœºå™¨äººï¼Œæ”¯æŒè¿œç¨‹å‘½ä»¤æ‰§è¡Œç­‰åŠŸèƒ½"
  author: "DevYK"
  schema_version: "2025.09.10"
  
  settings:
    timeout: 180
    max_retries: 3
    debug_mode: false

  # =================================================================
  # èŠ‚ç‚¹å®šä¹‰ (ç¬¦åˆ node_schema.base_structure)
  # =================================================================
  nodes:
    - name: "start_node"
      type: "start"
      description: "å·¥ä½œæµå¼€å§‹èŠ‚ç‚¹"
      position:
        x: 100
        y: 100
      outputs:
        - name: "user_input"
          type: "string"
          description: "ç”¨æˆ·è¾“å…¥å†…å®¹"

    - name: "chat_agent_with_mcp"
      type: "agent"
      description: "æ™ºèƒ½èŠå¤©æœºå™¨äºº Agent (é›†æˆ MCP)"
      agent_ref: "chat_agent_with_mcp"  # å¼•ç”¨ agents é…ç½®æ®µä¸­çš„ chat_agent_with_mcp
      position:
        x: 300
        y: 100
      
      inputs:
        - name: "user_message"
          type: "string"
          required: true
          source: "start_node.user_input"
          description: "ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯"
        - name: "thread_id"
          type: "string"
          required: false
          description: "å¯¹è¯çº¿ç¨‹IDï¼Œç”¨äºè®°å¿†ç®¡ç†"
      
      outputs:
        - name: "response"
          type: "string"
          description: "AIåŠ©æ‰‹çš„å›å¤"
        - name: "mcp_results"
          type: "array"
          description: "MCP å·¥å…·æ‰§è¡Œç»“æœåˆ—è¡¨"
        - name: "confidence"
          type: "number"
          description: "å›ç­”çš„ç½®ä¿¡åº¦"

    - name: "end_node"
      type: "end"
      description: "å·¥ä½œæµç»“æŸèŠ‚ç‚¹"
      position:
        x: 500
        y: 100
      inputs:
        - name: "final_response"
          type: "string"
          required: true
          source: "chat_agent_with_mcp.response"
          description: "æœ€ç»ˆå›å¤å†…å®¹"
        - name: "mcp_results"
          type: "array"
          required: false
          source: "chat_agent_with_mcp.mcp_results"
          description: "MCP å·¥å…·æ‰§è¡Œç»“æœ"

  # =================================================================
  # è¾¹å®šä¹‰ (ç¬¦åˆ edge_schema.base_structure)
  # =================================================================
  edges:
    - from: "start_node"
      to: "chat_agent_with_mcp"
      description: "ä¼ é€’ç”¨æˆ·è¾“å…¥åˆ°æ™ºèƒ½èŠå¤©Agent"
      
    - from: "chat_agent_with_mcp"
      to: "end_node"
      description: "è¾“å‡ºæœ€ç»ˆå›å¤å’Œ MCP æ‰§è¡Œç»“æœ"

# =================================================================
# ä½¿ç”¨è¯´æ˜
# =================================================================
usage_notes: |
  æ™ºèƒ½ MCP èŠå¤©æœºå™¨äººæ¨¡ç‰ˆä½¿ç”¨è¯´æ˜ï¼š
  
  1. åŠŸèƒ½ç‰¹ç‚¹ï¼š
     - å®Œå…¨ç¬¦åˆ KaFlow-Py åè®®æ ‡å‡†
     - é›†æˆ MCP (Model Context Protocol) å¤–éƒ¨å·¥å…·æœåŠ¡
     - æ”¯æŒè¿œç¨‹å‘½ä»¤æ‰§è¡Œå’Œå…¶ä»– MCP å·¥å…·
     - æ”¯æŒè¿ç»­å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£
     - è‡ªåŠ¨è®°å¿†ç®¡ç†ï¼ˆåŸºäºå…¨å±€memoryé…ç½®ï¼‰
     - ReAct Agent æ¶æ„ï¼Œæ”¯æŒæ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯
     - æ™ºèƒ½å·¥å…·é€‰æ‹©å’Œç»“æœè§£é‡Š
  
  2. MCP é›†æˆç‰¹æ€§ï¼š
     - ğŸŒ remote_exec: è¿œç¨‹å‘½ä»¤æ‰§è¡Œå·¥å…·
     - ğŸ”§ è‡ªåŠ¨å·¥å…·å‘ç°å’ŒåŠ è½½
     - ğŸ”„ å·¥å…·è°ƒç”¨é‡è¯•æœºåˆ¶
     - âš¡ SSE (Server-Sent Events) ä¼ è¾“åè®®
     - ğŸ›¡ï¸ å®‰å…¨çš„å·¥å…·è°ƒç”¨éªŒè¯
  
  3. ä½¿ç”¨ç¤ºä¾‹ï¼š
     - "åœ¨æœºå™¨ 420c126d598a97ee31fb70127b6b9a46 ä¸Šæ‰§è¡Œ ls -la å‘½ä»¤"
     - "æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ"
     - "è·å–è¿œç¨‹æœºå™¨çš„ç³»ç»Ÿä¿¡æ¯"
     - "æ‰§è¡Œè¿œç¨‹è„šæœ¬æˆ–å‘½ä»¤"
  
  4. ç¯å¢ƒå˜é‡ï¼š
     - DEEPSEEK_API_KEY: DeepSeek APIå¯†é’¥
     - æˆ–è€… OPENAI_API_KEY: OpenAI APIå¯†é’¥
  
  5. MCP æœåŠ¡å™¨è¦æ±‚ï¼š
     - æœåŠ¡å™¨åœ°å€: http://10.1.16.4:8000/mcp/sse
     - ä¼ è¾“åè®®: SSE (Server-Sent Events)
     - å¿…é¡»å®ç° MCP åè®®è§„èŒƒ
     - æä¾› remote_exec å·¥å…·
  
  6. å¯åŠ¨æ–¹å¼ï¼š
     python main.py --config config/chat_agent_mcp.yaml
  
  7. è‡ªå®šä¹‰é…ç½®ï¼š
     - ä¿®æ”¹ system_prompt å®šåˆ¶AIåŠ©æ‰‹çš„è¡Œä¸ºå’Œ MCP å·¥å…·ä½¿ç”¨ç­–ç•¥
     - è°ƒæ•´ temperature æ§åˆ¶å›ç­”çš„åˆ›é€ æ€§ï¼ˆMCPç‰ˆå»ºè®®è¾ƒä½å€¼ï¼‰
     - ä¿®æ”¹ max_tokens æ§åˆ¶å›ç­”é•¿åº¦
     - é…ç½® mcp_servers æ·»åŠ æ›´å¤šå¤–éƒ¨å·¥å…·æœåŠ¡
     - è®¾ç½®å·¥å…·è°ƒç”¨çš„è¶…æ—¶å’Œé‡è¯•å‚æ•°
  
  8. å®‰å…¨æ³¨æ„äº‹é¡¹ï¼š
     - MCP å·¥å…·å…·æœ‰å¼ºå¤§çš„è¿œç¨‹æ‰§è¡Œèƒ½åŠ›ï¼Œè¯·è°¨æ…ä½¿ç”¨
     - å»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­æµ‹è¯•
     - é¿å…æ‰§è¡Œå¯èƒ½é€ æˆæŸå®³çš„å‘½ä»¤
     - å®šæœŸæ£€æŸ¥å’Œå®¡è®¡å·¥å…·è°ƒç”¨æ—¥å¿— 